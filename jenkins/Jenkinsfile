pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3'
        VENV_DIR = 'venv'
    }
    
    stages {
        stage('Setup Environment') {
            steps {
                script {
                    sh 'echo "Setting up Python environment"' [cite: 2]
                    sh "python${PYTHON_VERSION} -m venv ${VENV_DIR}" [cite: 1]
                    sh ". ${VENV_DIR}/bin/activate && pip install --upgrade pip" [cite: 3]
                    sh ". ${VENV_DIR}/bin/activate && pip install -r requirements.txt" [cite: 4]
                }
            }
        }
        
        stage('Lint Code') {
            steps {
                script {
                    sh ". ${VENV_DIR}/bin/activate && flake8 app/ --output-file=reports/flake8.txt || true" [cite: 5, 6]
                    sh ". ${VENV_DIR}/bin/activate && pylint app/ --output=reports/pylint.txt || true" [cite: 7]
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/*.txt', allowEmptyArchive: true [cite: 8]
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                script {
                    sh 'docker rm -f unit-test-app || true' [cite: 9]
                    sh 'docker build -f docker/Dockerfile.app -t my-temp-app .' [cite: 1]
                    sh 'docker run -d -p 5000:5000 --name unit-test-app my-temp-app' [cite: 10]
                    sh 'mkdir -p reports'
                    sh ". ${VENV_DIR}/bin/activate && pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=html --junit-xml=reports/unit-tests.xml" [cite: 11]
                }
            }
            post {
                always {
                    sh 'docker rm -f unit-test-app || true' [cite: 12]
                    junit 'reports/unit-tests.xml' [cite: 12]
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true, [cite: 13]
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Unit Test Coverage Report' [cite: 14]
                    ])
                    archiveArtifacts artifacts: 'htmlcov/**/*', allowEmptyArchive: false [cite: 14]
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                script {
                    sh 'docker rm -f integration-test-app || true' [cite: 16]
                    sh 'docker build -f docker/Dockerfile.app -t my-temp-app .' [cite: 16]
                    sh 'docker run -d -p 5000:5000 --name integration-test-app my-temp-app' [cite: 17]
                    sh 'mkdir -p reports'
                    sh ". ${VENV_DIR}/bin/activate && pytest tests/integration/ -v --junit-xml=reports/integration-tests.xml" [cite: 18]
                }
            }
            post {
                always {
                    sh 'docker rm -f integration-test-app || true' [cite: 19]
                    junit 'reports/integration-tests.xml' [cite: 19]
                }
            }
        }
        
        stage('End-to-End Tests') {
            steps {
                script {
                    sh 'docker rm -f e2e-test-app || true' [cite: 20]
                    sh 'docker build -f docker/Dockerfile.app_selenium -t my-temp-app-selenium .' [cite: 20]
                    sh 'docker run -d -p 5000:5000 --name e2e-test-app my-temp-app-selenium' [cite: 21]
                    sh 'mkdir -p reports'
                    sh 'docker exec e2e-test-app pytest tests/e2e/ -v --junitxml=reports/e2e-tests.xml' [cite: 21]
                    sh 'docker cp e2e-test-app:/opt/DevOps-CI-CD-exercise/reports/e2e-tests.xml reports/e2e-tests.xml || true' [cite: 22]
                }
            }
            post {
                always {
                    sh 'docker rm -f e2e-test-app || true' [cite: 23]
                    junit 'reports/e2e-tests.xml' [cite: 23]
                }
            }
        }
        
        stage('Performance Tests') {
            steps {
                script {
                    sh 'docker rm -f performance-test-app || true' [cite: 24]
                    sh 'docker build -f docker/Dockerfile.app_prod -t performance-test-app .' [cite: 24]
                    sh 'docker run -d -p 5000:5000 --name performance-test-app performance-test-app' [cite: 25]
                    sh 'mkdir -p reports'
                    sh "locust -f tests/performance/locustfile.py --headless --users 10 --spawn-rate 2 --run-time 30s --host http://localhost:5000 --html reports/performance-report.html" [cite: 25]
                }
            }
            post {
                always {
                    sh 'docker rm -f performance-test-app || true' [cite: 27]
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports', [cite: 28]
                        reportFiles: 'performance-report.html',
                        reportName: 'Performance Test Report'
                    ]) [cite: 29]
                }
            }
        }
        
        stage('Build Docker Image') {
            when {
                anyOf {
                    branch 'main' [cite: 30]
                    branch 'develop' [cite: 30]
                }
            }
            steps {
                script {
                    sh """
                        docker build -t devops-testing-app:${BUILD_NUMBER} . [cite: 31]
                        docker tag devops-testing-app:${BUILD_NUMBER} devops-testing-app:latest [cite: 32]
                    """
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop' [cite: 33]
            }
            steps {
                script {
                    sh '''
                        echo "Deploying to staging environment"
                        docker stop staging-app || true [cite: 34, 35]
                        docker rm staging-app || true [cite: 36]
                        docker run -d --name staging-app -p 5001:5000 devops-testing-app:${BUILD_NUMBER}
                        sleep 5
                        curl -f http://localhost:5001/health || exit 1 [cite: 37]
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs() [cite: 38]
        }
        success {
            script {
                sh 'echo "Pipeline completed successfully!"' [cite: 39]
                emailext (
                    subject: "✅ Pipeline Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline completed successfully!</p>
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li> [cite: 39]
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li> [cite: 40]
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li> [cite: 40]
                            <li><strong>Reports:</strong> Check the artifacts section</li>
                        </ul> [cite: 41]
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL}"
                )
            }
        }
        failure {
            script {
                sh 'echo "Pipeline failed!"' [cite: 43]
                emailext (
                    subject: "❌ Pipeline Failure: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline failed!</p> [cite: 44]
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li> [cite: 44]
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li> [cite: 45]
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li> [cite: 45]
                            <li><strong>Failed Stage:</strong> ${currentBuild.currentResult}</li>
                        </ul>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """, [cite: 46]
                    to: "${env.CHANGE_AUTHOR_EMAIL}"
                )
            }
        }
    }
}