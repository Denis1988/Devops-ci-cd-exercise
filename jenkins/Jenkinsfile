pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3'
        VENV_DIR = 'venv'
    }
    
    stages {
        stage('Setup Environment') {
            steps {
                script {
                    sh 'echo "Setting up Python environment"'
                    sh "python${PYTHON_VERSION} -m venv ${VENV_DIR}"
                    sh ". ${VENV_DIR}/bin/activate && pip install --upgrade pip"
                    sh ". ${VENV_DIR}/bin/activate && pip install -r requirements.txt"
                }
            }
        }
        
        stage('Lint Code') {
            steps {
                script {
                    sh ". ${VENV_DIR}/bin/activate && flake8 app/ --output-file=reports/flake8.txt || true"
                    sh ". ${VENV_DIR}/bin/activate && pylint app/ --output=reports/pylint.txt || true"
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/*.txt', allowEmptyArchive: true
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                script {
                    sh 'docker rm -f unit-test-app || true'
                    sh 'docker build -f docker/Dockerfile.app -t my-temp-app .'
                    sh 'docker run -d -p 5000:5000 --name unit-test-app my-temp-app'
                    sh 'mkdir -p reports'
                    sh ". ${VENV_DIR}/bin/activate && pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=html --junit-xml=reports/unit-tests.xml"
                }
            }
            post {
                always {
                    sh 'docker rm -f unit-test-app || true'
                    junit 'reports/unit-tests.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Unit Test Coverage Report'
                    ])
                    archiveArtifacts artifacts: 'htmlcov/**/*', allowEmptyArchive: false
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                script {
                    sh 'docker rm -f integration-test-app || true'
                    sh 'docker build -f docker/Dockerfile.app -t my-temp-app .'
                    sh 'docker run -d -p 5000:5000 --name integration-test-app my-temp-app'
                    sh 'mkdir -p reports'
                    sh ". ${VENV_DIR}/bin/activate && pytest tests/integration/ -v --junit-xml=reports/integration-tests.xml"
                }
            }
            post {
                always {
                    sh 'docker rm -f integration-test-app || true'
                    junit 'reports/integration-tests.xml'
                }
            }
        }
        
        stage('End-to-End Tests') {
        steps {
            script {
            sh 'docker rm -f e2e-test-app || true'
            sh 'docker build -f docker/Dockerfile.app_selenium -t my-temp-app-selenium .'
            sh 'docker run -d --name e2e-test-app my-temp-app-selenium tail -f /dev/null'

            sh '''
                docker exec \
                -e HEADLESS=true \
                -e CI=true \
                -e PYTHONUNBUFFERED=1 \
                -e DISPLAY= \
                e2e-test-app \
                pytest tests/e2e/ -v \
                    --cov=app --cov-report=xml \
                    --junit-xml=reports/e2e-tests.xml
            '''

            sh 'mkdir -p reports'
            sh 'docker cp e2e-test-app:/opt/DevOps-CI-CD-exercise/reports/e2e-tests.xml reports/e2e-tests.xml'
            }
        }
        post {
            always {
            sh 'docker rm -f e2e-test-app || true'
            junit 'reports/e2e-tests.xml'
            }
        }
        }

        
        stage('Performance Tests') {
            steps {
                script {
                    sh 'docker rm -f performance-test-app || true'
                    sh 'docker build -f docker/Dockerfile.app_prod -t performance-test-app .'
                    sh 'docker run -d -p 5000:5000 --name performance-test-app performance-test-app'
                    sh 'mkdir -p reports'
                    sh "docker exec performance-test-app locust -f tests/performance/locustfile.py --headless --users 10 --spawn-rate 2 --run-time 30s --host http://localhost:5000 --html reports/performance-report.html"
                    //sh 'docker cp performance-test-app:/opt/DevOps-CI-CD-exercise/reports/performance-report.html reports/performance-report.html || true'
                    //sh 'locust -f locustfile.py --headless --users 10 --spawn-rate 2 --run-time 30s --host http://localhost:5000 --html reports/performance-report.html'
                }
            }
            post {
                always {
                    sh 'docker rm -f performance-test-app || true'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'performance-report.html',
                        reportName: 'Performance Test Report'
                    ])
                }
            }
        }

        stage('Build and Push Images') {
            steps {
                script {
                    def dockerHubUser = "denis20"
                    def githubUser    = "denis1988"
                    def repoName      = "devops-ci-cd-exercise"

                    sh "docker build -f docker/Dockerfile.app_prod -t ${repoName}:${BUILD_NUMBER} ."

                    withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', 
                                                    passwordVariable: 'DOCKER_HUB_PASSWORD', 
                                                    usernameVariable: 'DOCKER_HUB_USER')]) {
                        sh "echo \$DOCKER_HUB_PASSWORD | docker login -u \$DOCKER_HUB_USER --password-stdin"
                        sh "docker tag ${repoName}:${BUILD_NUMBER} ${dockerHubUser}/${repoName}:${BUILD_NUMBER}"
                        sh "docker tag ${repoName}:${BUILD_NUMBER} ${dockerHubUser}/${repoName}:latest"
                        sh "docker push ${dockerHubUser}/${repoName}:${BUILD_NUMBER}"
                        sh "docker push ${dockerHubUser}/${repoName}:latest"
                    }

                    withCredentials([usernamePassword(credentialsId: 'github-creds', 
                                                    passwordVariable: 'GH_PAT', 
                                                    usernameVariable: 'GH_USER')]) {
                        sh "echo \$GH_PAT | docker login ghcr.io -u \$GH_USER --password-stdin"
                        sh "docker tag ${repoName}:${BUILD_NUMBER} ghcr.io/${githubUser}/${repoName}:${BUILD_NUMBER}"
                        sh "docker tag ${repoName}:${BUILD_NUMBER} ghcr.io/${githubUser}/${repoName}:latest"
                        sh "docker push ghcr.io/${githubUser}/${repoName}:${BUILD_NUMBER}"
                        sh "docker push ghcr.io/${githubUser}/${repoName}:latest"
                    }
                }
            }
        }


        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    sh '''
                        echo "Deploying to staging environment"
                        docker stop staging-app || true
                        docker rm staging-app || true
                        docker run -d --name staging-app -p 5001:5000 devops-testing-app:${BUILD_NUMBER}
                        sleep 5
                        curl -f http://localhost:5001/health || exit 1
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            script {
                sh 'echo "Pipeline completed successfully!"'
                emailext (
                    subject: "✅ Pipeline Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline completed successfully!</p>
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li>
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li>
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
                            <li><strong>Reports:</strong> Check the artifacts section</li>
                        </ul>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL}"
                )
            }
        }
        failure {
            script {
                sh 'echo "Pipeline failed!"'
                emailext (
                    subject: "❌ Pipeline Failure: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline failed!</p>
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li>
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li>
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
                            <li><strong>Failed Stage:</strong> ${currentBuild.currentResult}</li>
                        </ul>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL}"
                )
            }
        }
    }
}